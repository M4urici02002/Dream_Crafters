<%- include('includes/navbar.ejs') %> <%- include('includes/sidebar.ejs') %>
<!-- CSS de Bootstrap Datepicker y Font Awesome -->
<link
  href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"
  rel="stylesheet"
/>
<link
  href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css"
  rel="stylesheet"
/>
<link rel="stylesheet" href="/css/botones.css" />

<div class="main p-3">
  <div class="container graficas">
    <div class="btn-group d-flex" role="group" aria-label="Menu de gráficas">
      <button
        type="button"
        id="numeroResenas"
        class="btn btn-outline-secondary flex-fill"
      >
        Número de reseñas
      </button>
      <button
        type="button"
        id="calificacionEstrellas"
        class="btn btn-outline-dark active flex-fill"
      >
        Calificación de estrellas
      </button>
      <button
        type="button"
        id="orderToReview"
        class="btn btn btn-outline-secondary flex-fill"
      >
        Respuestas
      </button>
    </div>
    <br />

    <div class="row">
      <div class="col-sm-4">
        <select
          class="form-select form-select-sm"
          aria-label="Small select example"
          id="categoriaDropdown"
        >
          <option value="">Seleccione una categoría</option>
          <% categorias.forEach(categoria => { %>
          <option value="<%= categoria.Categoria %>">
            <%= categoria.Categoria %>
          </option>
          <% }); %>
        </select>
      </div>
      <div class="col-sm-4">
        <select
          class="form-select form-select-sm"
          aria-label="Small select example"
          id="productoDropdown"
        >
          <option value="todosProductos">Todos los productos</option>
        </select>
      </div>
      <div class="col-sm-4">
        <div id="date-range-container" class="container">
          <div class="row no-gutters" id="formsFechasInicioFin">
            <div class="col-sm-6">
              <div class="form-group">
                <input
                  type="text"
                  id="start-date"
                  name="start-date"
                  class="form-control"
                  placeholder="Fecha de Inicio"
                />
              </div>
            </div>
            <div class="col-sm-6">
              <div class="form-group">
                <input
                  type="text"
                  id="end-date"
                  name="end-date"
                  class="form-control"
                  placeholder="Fecha de fin"
                />
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <% datos.forEach(function(calificacion) { %>
    <div class="calificacion-estrellas"></div>
    <% }); %>

    <div class="row mt-4">
      <div class="col-12" style="width: 100%; height: 400px">
        <canvas id="chartEstrellas"></canvas> <br />
        <div class="btn-group d-flex" role="group">
          <br />
          <button type="button" id="exportar" class="btn btn-primary flex-fill">
            Exportar Graficas &nbsp;&nbsp;
            <i class="fa-solid fa-file-arrow-down" style="color: #ffffff;"></i>
          </button>
        </div>
      </div>
    </div>
    <%- include('includes/footer.ejs') %>

    <!-- Scripts para jQuery, Popper.js, Bootstrap, Bootstrap Datepicker, y Chart.js -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"
      integrity="sha512-t2JWqzirxOmR9MZKu+BMz0TNHe55G5BZ/tfTmXMlxpUY8tsTo3QMD27QGoYKZKFAraIPDhFv56HLdN11ctmiTQ=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.3.2/jspdf.debug.js"></script>
    <script>
      $(document).ready(function () {
        // Configuraciones de datepicker
        $("#start-date").datepicker({ format: "yyyy/mm/dd", autoclose: true });
        $("#end-date").datepicker({ format: "yyyy/mm/dd", autoclose: true });

        // Cargar productos basados en la categoría seleccionada
        $("#categoriaDropdown").on("change", function () {
          const categoriaSeleccionada = $(this).val();
          fetch(
            `/graficas/productosPorCategoria?categoria=${categoriaSeleccionada}`
          )
            .then((data) => data.json())
            .then((data) => {
              data.forEach((producto) =>
                $("#productoDropdown").append(
                  `<option value="${producto.Nombre}">${producto.Nombre}</option>`
                )
              );
            });
          $("#productoDropdown")
            .empty()
            .append('<option value="">Seleccione un producto</option>');
        });
        // Inicialización del gráfico de barras
        const ctx = document.getElementById("chartEstrellas").getContext("2d");
        const bgColor = {
          id: "bgColor",
          beforeDraw: (chart, options) => {
            const { ctx, width, height } = chart;
            ctx.fillStyle = "white";
            ctx.fillRect(0, 0, width, height);
            ctx.restore();
          },
        };
        const starRatings = ["⭐", "⭐⭐", "⭐⭐⭐", "⭐⭐⭐⭐", "⭐⭐⭐⭐⭐"];
        const labels = starRatings;
        const dataPoints = JSON.parse(
          "<%= JSON.stringify(datos.map(d => d.cantidad)) %>"
        );

        const chartEstrellas = new Chart(ctx, {
          type: "bar",
          data: {
            labels: labels,
            datasets: [
              {
                data: dataPoints,
                backgroundColor: [
                  "rgba(255, 99, 132, 0.2)",
                  "rgba(54, 162, 235, 0.2)",
                  "rgba(255, 206, 86, 0.2)",
                  "rgba(75, 192, 192, 0.2)",
                  "rgba(153, 102, 255, 0.2)",
                  "rgba(255, 159, 64, 0.2)",
                ],
                borderColor: [
                  "rgba(255, 99, 132, 1)",
                  "rgba(54, 162, 235, 1)",
                  "rgba(255, 206, 86, 1)",
                  "rgba(75, 192, 192, 1)",
                  "rgba(153, 102, 255, 1)",
                  "rgba(255, 159, 64, 1)",
                ],
                borderWidth: 1,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {},
              x: {},
            },
            plugins: {
              legend: {
                display: false, // Oculta el label de la gráfica
              },
            },
          },
          options: { responsive: true, maintainAspectRatio: false },
          plugins: [bgColor],
        });

        function getCookie(name) {
          let cookieArray = document.cookie.split(";");
          let cookie = cookieArray.find((c) => c.trim().startsWith(name + "="));
          if (cookie) {
            return cookie.split("=")[1];
          }
          return null;
        }

        const descargarPDF = () => {
          const canvas = document.getElementById("chartEstrellas");
          const imagenUno = canvas.toDataURL("image/jpeg", 1.0);
          const pdf = new jsPDF("landscape"); // Formato horizontal

          // Obtiene la marca seleccionada de las cookies
          const marcaSeleccionada = getCookie("marcaSeleccionada");

          // Valores dinámicos ajustados según selecciones
          const categoriaSeleccionada =
            $("#categoriaDropdown").val() || "Todas las categorías de la marca";
          let productoSeleccionado = $("#productoDropdown").val();

          // Ajustar el texto para "Todos los productos de la marca" si el valor es 'todosProductos'
          if (
            !productoSeleccionado ||
            productoSeleccionado === "todosProductos"
          ) {
            productoSeleccionado = "Todos los productos de la marca";
          }

          const fechaInicio =
            $("#start-date").val() || "Inicio de los registros";
          const fechaFin = $("#end-date").val() || "Fin de los registros";

          // Fondo azul para la sección superior
          pdf.setFillColor(125, 157, 209); // Fondo azul
          pdf.rect(0, 0, pdf.internal.pageSize.width, 105, "F"); // Rectángulo de fondo para los detalles del reporte

          // Texto en blanco para los detalles del reporte
          pdf.setTextColor(255, 255, 255);
          pdf.setFont("helvetica", "bold");
          pdf.setFontSize(40);
          pdf.text(
            "REPORTE - CALIFICACIÓN ESTRELLAS",
            pdf.internal.pageSize.width / 2,
            30,
            null,
            null,
            "center"
          );

          pdf.setFontSize(24);
          pdf.setFont("helvetica", "normal");
          pdf.text(
            `Marca: ${marcaSeleccionada}`,
            pdf.internal.pageSize.width / 2,
            45,
            null,
            null,
            "center"
          );
          pdf.text(
            `Categoría: ${categoriaSeleccionada}`,
            pdf.internal.pageSize.width / 2,
            60,
            null,
            null,
            "center"
          );
          pdf.text(
            `Producto: ${productoSeleccionado}`,
            pdf.internal.pageSize.width / 2,
            80,
            null,
            null,
            "center"
          );
          pdf.text(
            `Desde: ${fechaInicio} Hasta: ${fechaFin}`,
            pdf.internal.pageSize.width / 2,
            100,
            null,
            null,
            "center"
          );

          // Agregar la gráfica en la parte inferior de la misma página
          pdf.addImage(
            imagenUno,
            "JPEG",
            10,
            110,
            pdf.internal.pageSize.width - 20,
            pdf.internal.pageSize.height - 120
          );

          // Guardar el PDF
          pdf.save("reporte.pdf");
        };

        function actualizarGrafica() {
          console.log("Actualizando");
          const categoriaSeleccionada = $("#categoriaDropdown").val();
          const productoSeleccionado = $("#productoDropdown")
            .val()
            .replace("+", "%2B");
          const fechaInicio = $("#start-date").val();
          const fechaFin = $("#end-date").val();

          fetch(
            `/graficas/calificacionesFiltradas?categoria=${categoriaSeleccionada}&producto=${productoSeleccionado}&fechaInicio=${fechaInicio}&fechaFin=${fechaFin}`
          )
            .then((response) => response.json())
            .then((data) => {
              const updatedLabels = data.map((d) => `${d.rating} estrellas`);
              const updatedData = data.map((d) => d.cantidad);
              console.log(updatedData);
              console.log(data);

              chartEstrellas.data.labels = updatedLabels;
              chartEstrellas.data.datasets[0].data = updatedData;
              chartEstrellas.update();
            })
            .catch((error) =>
              console.error("Error al actualizar la gráfica:", error)
            );
        }
        // Escuchar cambios en los dropdowns y datepickers
        $("#categoriaDropdown, #productoDropdown, #start-date, #end-date").on(
          "change",
          actualizarGrafica
        );

        $("#numeroResenas").click(function () {
          window.location.href = "/graficas";
        });
        $("#calificacionEstrellas").click(function () {
          window.location.href = "/graficas/calificacionEstrellas";
        });
        $("#orderToReview").click(function () {
          window.location.href = "/graficas/orderToReview";
        });
        $("#exportar").click(function () {
          descargarPDF();
        });
      });
    </script>
  </div>
</div>
